{% extends "main.j2" %}
{% block content %}

{# Error messages from URL parameters #}
{% set msg = request.args.get('msg') %}
{% set err = request.args.get('error') %}
{% if msg == 'delete_ok' %}
    <div class="success-message">
    Player successfully deleted.
    </div>
{% endif %}
{% if err == 'delete_unknown' %}
    <div class="error-message">
    Something went wrong while deleting that player. Please refresh the page and try again.
    </div>
{% endif %}
{% if err == 'create_unknown' %}
    <div class="error-message">
    Something went wrong while creating a player. Please ensure that you are not creating a duplicate entry.
    </div>
{% endif %}
{% if msg == 'create_ok' %}
    <div class="success-message">
    Player successfully added!
    </div>
{% endif %}

<h1>Players</h1>

{# READ table #}
<div class="roster-selection">
    <label for="roster_team_select">Choose Team for Roster</label>
    <select id="roster_team_select">
        <option value="" selected>All teams</option>
        {% if teams %}
            {% for team in teams %}
                <option value="{{ team.teamID }}">
                {{ team.teamID }}
                {{ team.schoolName }}
                -
                {{ team.sportType | title}}
                -
                {{ team.varsityJv | title }}
                {{ team.academicYear }}
                </option>
            {% endfor %}
        {% endif %}
    </select>
</div>
<table>
    <thead>
        {# Table attribute names #}
        <tr>
            {% for header in headers %}
            <th>{{ header }}</th>
            {% endfor %}
            <th></th>
        </tr>
    </thead>

    <tbody id="players_tbody">
    {# Display playerID, firstName, lastName, school, sport, level, season, year, active status, and eligibility status #}
    {% if players %}
        {% for player in players %}
        <tr>
            {% for value in player.values() %}
                <td>{{ value | title }}</td>
            {% endfor %}
            {# DELETE form #}
                <form id="delete_player_form" action="/players/delete" method="POST">
                    <input type="hidden" name="delete_playerID" value="{{ player.id }}">
                    <input type="hidden" name="delete_player_name" value="{{ player.first_name }} {{ player.last_name }}">
                    <td>
                        <button type="submit"
                                onclick="this.disabled=true; this.innerText=`Deleting...`; this.form.submit();">
                            Delete
                        </button>
                    </td>
                </form>
        </tr>
        {% endfor %}
    {% endif %}
    </tbody>
</table>

{# CREATE PLAYER form #}
<h2>Add Player to Roster</h2>
<form class="cuForm" id="create_player_form" action="/players/create" method="POST">

    {# Athlete Select #}
    <label for="create_player_athlete_select">Athlete: </label>
    <select name="athleteID" id="create_player_athlete_select">
        <option value="NULL" disabled selected>Select an Athlete</option>
        {% for athlete in athletes %}
            <option value="{{athlete.athleteID}}">
            {{ athlete['athleteID']}} - {{ athlete['firstName'] }} {{ athlete['lastName'] }}
            </option>
        {% endfor %}
    </select>

    {# Team Select #}
    <label for="create_player_team_select">Team: </label>
    <select name="teamID" id="create_player_team_select" required>
        <option value="NULL" disabled selected>Select a Team</option>
    </select>
    <input type="submit">
</form>

{# UPDATE PLAYER form #}
<h2>Update Athlete Team Assignment</h2>
<form class="cuForm" id="update_player_form">

    <label for="update_playerID">Player to Update: </label>
    <select name="update_playerID" id="update_playerID" required>
        <option value="" disabled selected>Select a Player</option>
        {% for player in players %}
        <option value="{{player['id']}}" required>
            {{player['id']}}
            -
            {{player['first_name']}}
            {{player['last_name']}}
            -
            {{ player['school'] }}
            -
            {{ player['sport'].title() }}
            {{ player['varsity_/_JV'].title() }}
            {{ player['academic_year'] }}
        </option>
        {% endfor %}
    </select>

    <label for="update_player_teamID">Team: </label>
    <select name="update_player_teamID" id="update_player_teamID" required>
        <option value="NULL" disabled selected>Select a Team</option>
{#        {% for team in teams %}#}
{#        <option value="{{team['teamID']}}" required>#}
{#            {{team['teamID']}}#}
{#            -#}
{#            {{team['schoolName'] | title}}#}
{#            -#}
{#            {{team['sportType'] | title}}#}
{#            -#}
{#            {{team['varsityJv'] | title}}#}
{#            {{team['academicYear']}}#}
{#        </option>#}
{#        {% endfor %}#}
    </select>

    <input type="submit">
</form>

{% endblock %}

{% block scripts %}
<script>
    {# Citation for use of AI tools #}
    {# Date:  11/10/2025 #}
    {# Prompts used to generate JS #}
    {# How would one implement a drop down on a form field (such as Athlete) that dynamically
    populates another field (such as Teams) based on the userâ€™s selection?
    How can I have a pre-populated table such as the list of Players updated based on the team
    selected by the user? #}

    const athleteSel = document.getElementById('create_player_athlete_select')
    const teamSel = document.getElementById('create_player_team_select')
    const rosterSel = document.getElementById('roster_team_select')
    const roster = document.getElementById('players_tbody')
    const updatePlayerSel = document.getElementById('update_playerID')
    const updateTeamSel = document.getElementById('update_player_teamID')

    {# Renders teams in creation dropdown based on athlete selected #}
    function renderTeams(teams) {
        teamSel.innerHTML = '';
        if (!teams || teams.length === 0) {
            teamSel.innerHTML = '<option value="">No teams available</option>';
            teamSel.disabled = true;
            return;
        }
        teamSel.insertAdjacentHTML('beforeend', '<option value="">Select Team</option>');
        teams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.teamID;
            opt.textContent = `${t.teamID} - ${t.teamName} - ${t.sportType} ${t.varsityJv} ${t.academicYear}`;
            teamSel.appendChild(opt);
        });
        teamSel.disabled = false;
    };

    {# Renders teams in update dropdown based on playerID selected #}
    function renderUpdateTeams(teams) {
        updateTeamSel.innerHTML = '';
        if (!teams || teams.length === 0) {
            updateTeamSel.innerHTML = '<option value="">No teams available</option>';
            updateTeamSel.disabled = true;
            return;
        }
        updateTeamSel.insertAdjacentHTML('beforeend', '<option value="">Select Team</option>');
        teams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.teamID;
            opt.textContent = `${t.teamID} - ${t.teamName} - ${t.sportType} ${t.varsityJv} ${t.academicYear}`;
            updateTeamSel.appendChild(opt);
        });
        updateTeamSel.disabled = false;
    };

    {# Renders roster based on team selected #}
    function renderRoster(players) {
        roster.innerHTML = '';

        if (!players || players.length == 0) {
            const tr = document.createElement('tr');
            tr.textContent = 'No players found in the database.';
            roster.appendChild(tr);
            return;
        }

        players.forEach(t => {
            const tr = document.createElement('tr');
            const cols = [
                t.id,
                t.first_name,
                t.last_name,
                t.school,
                t.sport,
                t['varsity_/_JV'],
                t.academic_year,
                t.eligible,
                t.active
            ];

            cols.forEach(val => {
                const td = document.createElement('td');
                td.textContent = val ?? '';
                tr.appendChild(td);
            });

            const actionTd = document.createElement('td');
            actionTd.innerHTML = `
          <form method="POST" action="/players/delete" class="inline-form">
            <input type="hidden" name="delete_playerID" value="${t.id}">
            <input type="hidden" name="delete_player_name" value="${ t.first_name } ${ t.last_name }">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
    `;
            tr.appendChild(actionTd);

            roster.appendChild(tr);
        })
    };

    {#  Event listener for athlete selector to add to roster #}
    athleteSel.addEventListener('change', async() => {
        const athleteID = athleteSel.value;
        const url = `/players/teams?athleteID=${encodeURIComponent(athleteID)}`;

        teamSel.disabled = true;
        teamSel.innerHTML = '<option>Loading...</option>';

        try {
            const res = await fetch(url, {headers: {'Accept': 'application/json'}});
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const teams = await res.json();
            renderTeams(teams);
        } catch (err) {
            console.error(err);
            teamSel.innerHTML = '<option value="">Error loading teams</option>';
            teamSel.disabled = true;
        }

    });

    {# Event listener for team selector to display roster #}
    rosterSel.addEventListener('change', async() => {
        const teamID = rosterSel.value
        const url = `/players/roster?teamID=${encodeURIComponent(teamID)}`

        try {
            const res = await fetch(url, {headers: {'Accept': 'application/json'}});
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const players = await res.json();
            renderRoster(players);
        } catch (err) {
            console.error(err);
        }
    });

    {# Event listener for player update selector to display eligible teams #}
    updatePlayerSel.addEventListener('change', async() => {
        const playerID = updatePlayerSel.value;
        const url = `/players/updateTeams?playerID=${encodeURIComponent(playerID)}`

        try {
            const res = await fetch(url, {headers: {'Accept': 'application/json'}});
            if (!res.ok) throw new Error (`HTTP ${res.status}`);
            const teams = await res.json();
            renderUpdateTeams(teams);
        } catch (err) {
            console.error(err);
        }
    })

</script>
{% endblock %}