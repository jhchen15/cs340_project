{% extends "main.j2" %}
{% block content %}

<h1>Players</h1>

{# READ table #}
<table>
    <thead>
        {# Table attribute names #}
        <tr>
            {% for key in players[0].keys() %}
            <th>{{ key.replace('_', ' ').title() }}</th>
            {% endfor %}
            <th></th>
        </tr>
    </thead>

    <tbody>
        {# For each row, print the playerID, firstName, lastName, school, sport, level,
        season, year, active status, and eligibility status#}
        {% for player in players %}
        <tr>
            {% for value in player.values() %}
                <td>{{ value | title }}</td>
            {% endfor %}
            {# DELETE form #}
                <form id="delete_player_form">
                    <input type="hidden" name="delete_playerID" value="{{ player.playerID }}">
                    <input type="hidden" name="delete_player_name" value="{{ player.firstName }} {{ player.lastName }}">
                    <td>
                        <button type="submit">
                            Delete
                        </button>
                    </td>
                </form>
        </tr>
        {% endfor %}
    </tbody>
</table>

{# CREATE form #}
<h2>Add Player to Roster</h2>
<form class="cuForm" id="create_player_form">

    {# Athlete #}
    <label for="create_player_athlete">Athlete: </label>
    <select name="create_player_athlete" id="create_player_athlete">
{#        <option value="NULL" disabled selected>Select an Athlete</option>#}
        {% for athlete in athletes %}
            <option value="{{athlete.athleteID}}">
            {{ athlete['athleteID']}} - {{ athlete['firstName'] }} {{ athlete['lastName'] }}
            </option>
        {% endfor %}
    </select>

    {# Team #}
    <label for="create_player_team">Team: </label>
    <select name="create_player_team" id="create_player_team" required>
        <option value="">Select a Team</option>
    </select>

    {# School Name dropdown #}
{#    <label for="create_player_schoolName">School: </label>#}
{#    <select name="create_player_schoolName" id="create_player_schoolName" required>#}
{#        <option value="NULL" disabled selected>Select a School</option>#}
{#        <option value="NULL">&lt; None &gt;</option>#}
{#        {% for school in schools %}#}
{#        <option value="{{school['schoolID']}}" required>{{school['schoolName']}}</option>#}
{#        {% endfor %}#}
{#    </select>#}
{##}
    {# Sport dropdown #}
{#    <label for="create_player_sportType">Sport: </label>#}
{#    <select name="create_player_sportType" id="create_player_sportType" required>#}
{#        <option value="NULL" disabled selected>Select a Sport</option>#}
{#        <option value="NULL">&lt; None &gt;</option>#}
{#        {% for school in schools %}#}
{#        <option value="{{school['sportType']}}" required>{{school['sportType']}}</option>#}
{#        {% endfor %}#}
{#    </select>#}
{##}
    {# Level dropdown #}
{#    <label for="create_player_varsityJv">Level: </label>#}
{#    <select name="create_player_varsityJv" id="create_player_varsityJv" required>#}
{#        <option value="NULL" disabled selected>Varsity/JV</option>#}
{#        <option value="NULL">&lt; None &gt;</option>#}
{#        {% for school in schools %}#}
{#        <option value="{{school['varsityJv']}}" required>{{school['varsityJv']}}</option>#}
{#        {% endfor %}#}
{#    </select>#}
{##}
    {# Year dropdown #}
{#    <label for="create_player_academicYear">Academic Year: </label>#}
{#    <select name="create_player_academicYear" id="create_player_academicYear" required>#}
{#        <option value="NULL" disabled selected>Year</option>#}
{#        <option value="NULL">&lt; None &gt;</option>#}
{#        {% for school in schools %}#}
{#        <option value="{{school['schoolID']}}" required>{{school['schoolName']}}</option>#}
{#        {% endfor %}#}
{#    </select>#}
{##}
    {# Athlete Name #}
{#    <label for="create_player_playerName">Name: </label>#}
{#    <select name="create_player_playerName" id="create_player_playerName" required>#}
{#        <option value="NULL" disabled selected>Name</option>#}
{#        <option value="NULL">&lt; None &gt;</option>#}
{#        {% for athlete in athletes %}#}
{#        <option value="{{athlete['athleteID']}}" required>{{athlete['lastName']}}, {{athlete['firstName']}}</option>#}
{#        {% endfor %}#}
{#    </select>#}

    <input type="submit">
</form>

{# UPDATE form #}
<h2>Update Athlete Team Assignment</h2>
<form class="cuForm" id="update_player_form">

    <label for="update_playerID">Player to Update: </label>
    <select name="update_playerID" id="update_playerID" required>
        <option value="" disabled selected>Select a Player</option>
{#        {% for player in people %}#}
{#        <option value="{{player['id']}}" required>#}
{#            {{player['id']}}#}
{#            -#}
{#            {{player['firstName']}}#}
{#            {{player['lastName']}}#}
{#        </option>#}
{#        {% endfor %}#}
    </select>

    <label for="update_player_teamID">Team: </label>
    <select name="update_player_teamID" id="update_player_teamID" required>
        <option value="NULL" disabled selected>Select a Team</option>
        <option value="NULL">&lt; None &gt;</option>
{#        {% for team in teams %}#}
{#        <option value="{{team['teamID']}}" required>#}
{#            {{team['teamID']}}#}
{#            {{team['schoolID']}}#}
{#            {{team['sportType']}}#}
{#            {{team['varsityJv']}}#}
{#            {{team['academicYear']}}#}
{#        </option>#}
{#        {% endfor %}#}
    </select>

    <input type="submit">
</form>

{% endblock %}

<script>
    const playerSel = document.getElementById('create_player_athlete')
    const teamSel = document.getElementById('create_player_team')

    function renderTeams(teams) {
        teamSel.innerHTML = '';
        if (!teams || teams.length === 0) {
            teamSel.innerHTML = '<option value="">No teams available</option>';
            teamSel.disabled = true;
            return;
        }
        teamSel.insertAdjacentHTML('beforeend', '<option value="">Select Team</option>');
        teams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.teamID;
            opt.textContent = t.teamName;
            teamSel.appendChild(opt);
        });
        teamSel.disabled = false;
    }

    playerSel.addEventListener('change', async() => {
        {#const selected = playerSel.selectedOptions[0];#}
        const schoolID = playerSel.value;

        const url = `/players/teams?schoolID=${encodeURIComponent(schoolID)}`;

        teamSel.disabled = true;
        teamSel.innerHTML = '<option>Loading...</option>';

        try {
            const res = await fetch(url, {headers: {'Accept': 'application/json'}});
            if (!res.ok) throw new Error('HTTP ${res.status}');
            const teams = await res.json();
            renderTeams(teams);
        } catch (err) {
            console.error(err);
            teamSel.innerHTML = '<option value="">Error loading teams</option>';
            teamSel.disabled = true;
        }

    });
</script>