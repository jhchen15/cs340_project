{% extends "main.j2" %}
{% block content %}

{# Error messages from URL parameters #}
{% set msg = request.args.get('msg') %}
{% set err = request.args.get('error') %}
{% if msg == 'delete_ok' %}
    <div class="success-message">
    Athlete successfully deleted.
    </div>
{% endif %}
{% if msg == 'create_ok' %}
    <div class="success-message">
    Athlete successfully added!
    </div>
{% endif %}
{% if msg == 'update_ok' %}
    <div class="success-message">
    Athlete successfully updated.
    </div>
{% endif %}
{% if err == 'athlete_has_players' %}
    <div class="error-message">
    This athlete cannot be deleted because they are currently assigned to one or more teams. Please remove the athlete from all teams first.
    </div>
{% elif err == 'athlete_constraint_error' %}
    <div class="error-message">
    This athlete cannot be deleted due to existing references in the database.
    </div>
{% elif err == 'delete_failed' %}
    <div class="error-message">
    An error occurred while deleting the athlete.
    </div>
{% elif err == 'create_failed' %}
    <div class="error-message">
    An error occurred while creating the athlete. Please check all fields and try again.
    </div>
{% elif err == 'update_failed' %}
    <div class="error-message">
    An error occurred while updating the athlete. Please check all fields and try again.
    </div>
{% endif %}

<h1>Athletes</h1>

{# READ table #}
<table>
    <thead>
        {# Table attribute names using headers #}
        <tr>
            {% for header in headers %}
            <th>{{ header }}</th>
            {% endfor %}
            <th></th>
        </tr>
    </thead>

    <tbody>
        {# For each row, print all athlete attributes #}
        {% if athletes %}
            {% for athlete in athletes %}
            <tr>
                {% for value in athlete.values() %}
                    <td>{{ value | title }}</td>
                {% endfor %}

                {# DELETE form #}
                <form id="delete_athlete_form" method="POST" action="/athletes/delete">
                    <input type="hidden" name="delete_athlete_id" value="{{ athlete.Id }}">
                    <input type="hidden" name="delete_athlete_name" value="{{ athlete['First Name'] }} {{ athlete['Last Name'] }}">
                    <td>
                        <button type="submit"
                                onclick="this.disabled=true; this.innerText=`Deleting...`; this.form.submit();">
                            Delete
                        </button>
                    </td>
                </form>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="{{ headers|length + 1 }}" style="text-align: center;">No athletes found</td>
            </tr>
        {% endif %}
    </tbody>
</table>

{# CREATE form #}
<h2>Create an Athlete</h2>
<form class="cuForm" id="create_athlete_form" method="POST" action="/athletes/create">
    <label for="create_athlete_school">School: </label>
    <select name="create_athlete_school" id="create_athlete_school" required>
        <option value="" disabled selected>Select a School</option>
        {% for school in schools %}
        <option value="{{school['schoolID']}}" required>{{school['name']}}</option>
        {% endfor %}
    </select>

    <label for="create_athlete_firstName">First Name: </label>
    <input type="text" name="create_athlete_firstName" id="create_athlete_firstName" required>

    <label for="create_athlete_lastName">Last Name: </label>
    <input type="text" name="create_athlete_lastName" id="create_athlete_lastName" required>

    <label for="create_athlete_gradeLevel">Grade Level: </label>
    <input type="number" name="create_athlete_gradeLevel" id="create_athlete_gradeLevel" min="9" max="12" required>

    <label for="create_athlete_isEligible">Is Eligible: </label>
    <select name="create_athlete_isEligible" id="create_athlete_isEligible" required>
        <option value="1" selected>Yes</option>
        <option value="0">No</option>
    </select>

    <label for="create_athlete_isActive">Is Active: </label>
    <select name="create_athlete_isActive" id="create_athlete_isActive" required>
        <option value="1" selected>Yes</option>
        <option value="0">No</option>
    </select>

    <label for="create_athlete_emergencyContact">Emergency Contact: </label>
    <input type="text" name="create_athlete_emergencyContact" id="create_athlete_emergencyContact">

    <input type="submit">
</form>

{# UPDATE form #}
<h2>Update an Athlete</h2>
<form class="cuForm" id="update_athlete_form" method="POST" action="/athletes/update">
    <label for="update_athlete_id">Athlete to Update: </label>
    <select name="update_athlete_id" id="update_athlete_id" required>
        <option value="" disabled selected>Select an Athlete</option>
        {% for athlete in athletes %}
        <option value="{{athlete['Id']}}" required>
            {{athlete['Id']}} - {{athlete['First Name']}} {{athlete['Last Name']}} ({{athlete['School']}})
        </option>
        {% endfor %}
    </select>

    <label for="update_athlete_school">School: </label>
    <select name="update_athlete_school" id="update_athlete_school" required>
        <option value="" disabled selected>Select a School</option>
        {% for school in schools %}
        <option value="{{school['schoolID']}}" required>{{school['name']}}</option>
        {% endfor %}
    </select>

    <label for="update_athlete_firstName">First Name: </label>
    <input type="text" name="update_athlete_firstName" id="update_athlete_firstName" required>

    <label for="update_athlete_lastName">Last Name: </label>
    <input type="text" name="update_athlete_lastName" id="update_athlete_lastName" required>

    <label for="update_athlete_gradeLevel">Grade Level: </label>
    <input type="number" name="update_athlete_gradeLevel" id="update_athlete_gradeLevel" min="9" max="12" required>

    <label for="update_athlete_isEligible">Is Eligible: </label>
    <select name="update_athlete_isEligible" id="update_athlete_isEligible" required>
        <option value="1">Yes</option>
        <option value="0">No</option>
    </select>

    <label for="update_athlete_isActive">Is Active: </label>
    <select name="update_athlete_isActive" id="update_athlete_isActive" required>
        <option value="1">Yes</option>
        <option value="0">No</option>
    </select>

    <label for="update_athlete_emergencyContact">Emergency Contact: </label>
    <input type="text" name="update_athlete_emergencyContact" id="update_athlete_emergencyContact">

    <input type="submit" value="Update Athlete">
</form>

{% endblock %}

{% block scripts %}
<script>
    // Athlete update form auto-population
    const athleteUpdateSelect = document.getElementById('update_athlete_id');
    const updateSchoolSelect = document.getElementById('update_athlete_school');
    const updateFirstName = document.getElementById('update_athlete_firstName');
    const updateLastName = document.getElementById('update_athlete_lastName');
    const updateGradeLevel = document.getElementById('update_athlete_gradeLevel');
    const updateIsEligible = document.getElementById('update_athlete_isEligible');
    const updateIsActive = document.getElementById('update_athlete_isActive');
    const updateEmergencyContact = document.getElementById('update_athlete_emergencyContact');

    athleteUpdateSelect.addEventListener('change', async function() {
        const athleteID = this.value;
        
        if (!athleteID) {
            // Clear all fields if no athlete selected
            updateSchoolSelect.value = '';
            updateFirstName.value = '';
            updateLastName.value = '';
            updateGradeLevel.value = '';
            updateIsEligible.value = '1';
            updateIsActive.value = '1';
            updateEmergencyContact.value = '';
            return;
        }

        try {
            const response = await fetch(`/athletes/details?athleteID=${encodeURIComponent(athleteID)}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const athlete = await response.json();
            
            // Populate form fields
            updateSchoolSelect.value = athlete.schoolID;
            updateFirstName.value = athlete.firstName;
            updateLastName.value = athlete.lastName;
            updateGradeLevel.value = athlete.gradeLevel;
            updateIsEligible.value = athlete.isEligible ? '1' : '0';
            updateIsActive.value = athlete.isActive ? '1' : '0';
            updateEmergencyContact.value = athlete.emergencyContact || '';
            
        } catch (error) {
            console.error('Error loading athlete details:', error);
            alert('Error loading athlete details. Please try again.');
        }
    });
</script>

{% endblock %}