{% extends "main.j2" %}
{% block content %}

<h1>Scheduled Games</h1>

{# READ table #}
<table>
    <thead>
        {# Table attribute names #}
        <tr>
            {% for header in headers %}
            <th>{{ header }}</th>
            {% endfor %}
            <th></th>
        </tr>
    </thead>

    <tbody>
    {# Display game id, home / away team names, facility location, facility name, date, time, type and status #}
    {% if games %}
        {% for game in games %}
        <tr>
            {% for value in game.values() %}
                <td>{{ value | title }}</td>
            {% endfor %}

            {# DELETE form #}
            <form id="delete_game_form" action="/games/delete" method="POST">
                <input type="hidden" name="delete_gameID" value="{{ game.id }}">
                <td>
                    <button type="submit">
                        Delete
                    </button>
                </td>
            </form>
        </tr>
        {% endfor %}
    {% endif %}
    </tbody>
</table>

{# CREATE form #}
<h2>Create game</h2>
<form class="cuForm" id="create_game_form">

    {# Sport selection #}
    <label for="create_game_sport">Sport: </label>
    <select name="create_game_sport" id="create_game_sport" required>
        <option value="NULL" selected disabled>Select a Sport</option>
        {% for sport in sportTypes %}
        <option value="{{ sport["sportType"] }}" required>
            {{ sport["sportType"].title() }}
        </option>
        {% endfor %}
    </select>

    {# Home team #}
    <label for="create_game_homeTeam">Home Team: </label>
    <select name="create_game_homeTeam" id="create_game_homeTeam" required>
        <option value="NULL" selected disabled>Select a Team</option>
    </select>

    {# Away team #}
    <label for="create_game_awayTeam">Away Team: </label>
    <select name="create_game_awayTeam" id="create_game_awayTeam" required>
        <option value="NULL" selected disabled>Select a Team</option>
    </select>

    {# Facility #}
    <label for="create_game_facility">Facility: </label>
    <select name="create_game_facility" id="create_game_facility" required>
        <option value="NULL" selected disabled>Select a Facility</option>
        {% for facility in facilities %}
        <option value="{{facility['facilityID']}}" required>{{facility['facilityName']}}</option>
        {% endfor %}
    </select>

    {# Date #}
    <label for="create_game_gameDate">Date: </label>
    <input type="date" name="create_game_gameDate" id="create_game_gameDate">

    {# Time #}
    <label for="create_game_gameTime">Time: </label>
    <input type="time" name="create_game_gameTime" id="create_game_gameTime">

    {# Game type #}
    <label for="create_game_gameType">Game Type: </label>
    <select name="create_game_gameType" id="create_game_gameType" required>
        <option value="NULL" selected disabled>Type</option>
        <option value="preseason">Preseason</option>
        <option value="regular season">Regular Season</option>
        <option value="playoff">Playoff</option>
        <option value="tournament">Tournament</option>
        <option value="exhibition">Exhibition</option>
    </select>

    {# Game status #}
    <label for="create_game_gameStatus">Status: </label>
    <select name="create_game_gameStatus" id="create_game_gameStatus" required>
        <option value="NULL" selected disabled>Status</option>
        <option value="scheduled">Scheduled</option>
        <option value="in progress">In Progress</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
        <option value="postponed">Postponed</option>
        <option value="forfeited">Forfeited</option>
    </select>

    <input type="submit">
</form>

{# UPDATE form #}
<h2>Update game</h2>
<form class="cuForm" id="update_game_form">

    {# Game to update #}
    <label for="update_game_gameID">Game to Update: </label>
    <select name="update_game_gameID" id="update_game_gameID" required>
        <option value="NULL" disabled selected>Select a game</option>
        {% for game in games %}
        <option value="{{game['id']}}" required>
            {{game['id']}}
            -
            {{game['home_team']}} (H) vs.
            {{game['away_team']}} (A)
            -
            {{game['game_date']}}
            -
            {{game['game_time']}}
        </option>
        {% endfor %}
    </select>

    {# Update game facility #}
    <label for="update_game_facility">Facility: </label>
    <select name="update_game_facilityID" id="update_game_facilityID" required>
        <option value="NULL" selected>Select a Facility</option>
        {% for facility in facilities %}
        <option value="{{facility['facilityID']}}" required>
            {{facility['facilityName']}}
        </option>
        {% endfor %}
    </select>

    {# Update game date #}
    <label for="update_game_gameDate">Date: </label>
    <input type="date" name="update_game_gameDate" id="update_game_gameDate">

    {# Update game time #}
    <label for="update_game_gameTime">Time: </label>
    <input type="time" name="update_game_gameTime" id="update_game_gameTime">

    {# Update game type #}
    <label for="update_game_gameType">Game Type: </label>
    <select name="update_game_gameType" id="update_game_gameType" required>
        <option value="NULL" selected>Type</option>
        <option value="NULL">&lt; None &gt;</option>
    </select>

    {# Update game status #}
    <label for="update_game_gameStatus">Status: </label>
    <select name="udpate_game_gameStatus" id="update_game_gameStatus" required>
        <option value="NULL" selected>Status</option>
        <option value="NULL">&lt; None &gt;</option>
    </select>

    <input type="submit">
</form>

{% endblock %}

{% block scripts %}
<script>
    {# Citation for use of AI tools #}
    {# Date:  11/10/2025 #}
    {# Prompts used to generate JS #}
    {# How would one implement a drop down on a form field (such as Athlete) that dynamically
    populates another field (such as Teams) based on the userâ€™s selection?
    How can I have a pre-populated table such as the list of Players updated based on the team
    selected by the user? #}


    const sportSel = document.getElementById('create_game_sport')
    const homeTeamSel = document.getElementById('create_game_homeTeam')
    const awayTeamSel = document.getElementById('create_game_awayTeam')

    {# Render teams in the dropdown selections #}
    function renderTeams(teams, teamElement) {
        teamElement.innerHTML = "";
        if (!teams || teams.length === 0) {
            teamElement.innerHTML = `<option value="">No teams available</option>`
            teamElement.disabled = true;
            return;
        }
        teamElement.insertAdjacentHTML('beforeend', `<option value="">Select Team</option>`);
        teams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.teamID;
            opt.textContent = `${t.teamID} ${t.schoolName} ${t.varsityJv} ${t.academicYear}`;
            teamElement.appendChild(opt);
        })
        teamElement.disabled = false;
    }

    {# Event fires to render teams after sport selection #}
    sportSel.addEventListener('change', async() => {
        console.log('Adding sport selection event listener')
        const sportType = sportSel.value;
        const url = `/games/teams?sportType=${encodeURIComponent(sportType)}`

        homeTeamSel.disabled = true;
        homeTeamSel.innerHTML = `<option>Loading...</option>`;
        awayTeamSel.disabled = true;
        awayTeamSel.innerHTML = `<option>Loading...</option>`;

        try {
            const res = await fetch(url, {headers: {'Accept': 'application/json'}});
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const teams = await res.json();
            renderTeams(teams, homeTeamSel);
            renderTeams(teams, awayTeamSel)
        } catch (err) {
            console.error(err)
            homeTeamSel.innerHTML = (`<option value="">Error loading teams</option>`);
            homeTeamSel.disabled = true;
            awayTeamSel.innerHTML = (`<option value="">Error loading teams</option>`);
            awayTeamSel.disabled = true;
        }
    })

</script>
{% endblock %}